#!/usr/bin/env python

import Params
Params.g_autoconfig=1

srcdir = '.'
blddir = 'build'

def set_options(opt):
	pass

def configure(conf):
	conf.check_tool('gcc g++ nasm')
	cflags = '-Wall -Wextra -Werror -I../lib -I../memory -I../pd -I../schedule -I../boot'
	cflags += ' -I../arch/x86' #FIXME: archdep
	cflags += ' -O3' #FIXME: builddep
	flags = '-nostdlib -nostartfiles -nodefaultlibs -fno-builtin -fno-stack-protector -fno-leading-underscore -fno-exceptions'
	conf.env['CCFLAGS'] += [cflags + ' ' + flags]
	conf.env['CXXFLAGS'] += [cflags + ' -fno-rtti ' + flags]
	conf.env['CXXDEFINES'] += ['CONFIG_CPU_IA32_P4'] #FIXME: archdep
	conf.env['LINKFLAGS'] += ['-T ../linker.ld ' + flags]
	conf.env['NASM_FLAGS'] += ['-f elf']
	conf.write_config_header('config.h')

def build(bld):
	obj = bld.create_obj('cpp', 'program')
	obj.find_sources_in_dirs('. boot lib memory pd schedule')
	obj.source.remove('boot/boot.asm')
	obj.target = 'vesper'
